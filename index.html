<!DOCTYPE html>
<meta charset="utf-8">
<style>
.link {
  stroke: #000;
}
</style>
<body>
<script src="http://d3js.org/d3.v2.js?2.9.3"></script>
<script>

var width = 960,
    height = 500,
    interval = 1000,
	t=0,
	node_sum = 0;

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var force = d3.layout.force()
	.friction(.99)
	.gravity(0.02)
	.charge(-20)
    .size([width, height]);

var CO2 = [{"source": "O1","target": "C2"},{"source": "C2","target": "O3"}]

makemolecule(CO2)

function makemolecule(links){
    var links_temp = links
	var nodesByName = {};
	links_temp.forEach(function(link) {
		link.source = nodeByName(link.source);
		link.target = nodeByName(link.target);
	});
	
	var nodes = d3.values(nodesByName);
	
	var link = svg.selectAll(".link")
	  .data(links_temp)
	.enter().append("line")
	  .attr("class", "link");
	
	
	var node = svg.selectAll(".node")
	  .data(nodes)
	.enter().append("circle")
	  .attr("class", "node")
	  .attr("r", function(d) { return (d.name[0]=="C" )? 4.5:4.5*16/12;} )
	  .style("fill", function(d) { return (d.name[0]=="C" )? "#000": "red";} )
	  .style("stroke", function(d) { return "#eee"; })
	  .call(force.drag);
	
	
	force
	  .nodes(nodes)
	  .links(links_temp)
	  .on("tick", tick)
	  .start();
	
	function tick() {
		link.attr("x1", function(d) { return d.source.x; })
			.attr("y1", function(d) { return d.source.y; })
			.attr("x2", function(d) { return d.target.x; })
			.attr("y2", function(d) { return d.target.y; });
		
		 node.attr("cx", function(d) { return d.x = Math.max(4.5, Math.min(width - 4.5, d.x)); })
        	 .attr("cy", function(d) { return d.y = Math.max(4.5, Math.min(height - 4.5, d.y)); });
	}
	
	function nodeByName(name) {
		return nodesByName[name] || (nodesByName[name] = {name: name});
	}
	
	//Start the loop!
	var carbons = 0;
	refreshIntervalId = setInterval(function(){
	  t = t + interval*0.009;
	  
	  if(Math.random() > 0.1){
		  links.push( {"source": nodeByName("O"+(t+1)),"target": nodeByName("C"+(t+2))})
		  links.push( {"source": nodeByName("C"+(t+2)),"target": nodeByName("O"+(t+3))})
		  links.push( {"source": nodeByName("O"+(t+4)),"target": nodeByName("C"+(t+5))})
		  links.push( {"source": nodeByName("C"+(t+5)),"target": nodeByName("O"+(t+6))})
		  links.push( {"source": nodeByName("O"+(t+7)),"target": nodeByName("C"+(t+8))})
		  links.push( {"source": nodeByName("C"+(t+8)),"target": nodeByName("O"+(t+9))})
		  carbons = carbons + 3;
	  }else{
	      links.push( {"source": nodeByName("O"+(t+1)),"target": nodeByName("C"+(t+2))})
		  links.push( {"source": nodeByName("O"+(t+4)),"target": nodeByName("C"+(t+5))})
		  links.push( {"source": nodeByName("O"+(t+7)),"target": nodeByName("C"+(t+8))})
		  links.push( {"source": nodeByName("C"+(t+8)),"target": nodeByName("O"+(t+9))})
		  carbons = carbons + 3;
	  }
		
	  nodes = d3.values(nodesByName);

	  link = link.data(links)
	  
	  link.enter().append("line")
		  .attr("class", "link")

	  node = node.data(nodes);
	  node.enter().append("circle")
		  .attr("class", "node")
		  .attr("cx", function(d) { return d.x; })
		  .attr("cy", function(d) { return d.y; })
		  .attr("r", function(d) { return (d.name[0]=="C" )? 4.5:4.5*16/12;} )
		  .style("fill", function(d) { return (d.name[0]=="C" )? "#000": "red";} )
		  .style("stroke", function(d) { return "#eee"; })
		  .call(force.drag)
		  
	   force
		  .nodes(nodes)
		  .links(links)
		  .on("tick", tick)
		  .start();

	  if(carbons>50){
		t = 0; 
		nodesByName = {};
		links = [];
		carbons = 0
		d3.selectAll("circle").transition().duration(200).attr("r", 0.2).remove()
		d3.selectAll("line").remove()
	  }
	}, 1000);
}

</script>